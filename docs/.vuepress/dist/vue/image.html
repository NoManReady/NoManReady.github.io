<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>NoManReady | 图片上传</title>
    <meta name="description" content="Enjoy Vue">
  <link rel="icon" href="/favicon.ico">
  <script src="/plugin.js" defer="defer"></script>
    
    <link rel="preload" href="/assets/css/0.styles.fae609a6.css" as="style"><link rel="preload" href="/assets/js/app.9b3061e8.js" as="script"><link rel="preload" href="/assets/js/3.e6e231a2.js" as="script"><link rel="prefetch" href="/assets/js/15.a8fe9b6e.js"><link rel="prefetch" href="/assets/js/1.c58dbcd4.js"><link rel="prefetch" href="/assets/js/2.ddc3c7f8.js"><link rel="prefetch" href="/assets/js/4.1cd51ba3.js"><link rel="prefetch" href="/assets/js/5.9e802ac2.js"><link rel="prefetch" href="/assets/js/6.457a4708.js"><link rel="prefetch" href="/assets/js/7.8f1ba653.js"><link rel="prefetch" href="/assets/js/8.850e0571.js"><link rel="prefetch" href="/assets/js/9.b27c780f.js"><link rel="prefetch" href="/assets/js/10.0f239320.js"><link rel="prefetch" href="/assets/js/11.8a3c563e.js"><link rel="prefetch" href="/assets/js/12.3fa6aa2e.js"><link rel="prefetch" href="/assets/js/13.a1917d8d.js"><link rel="prefetch" href="/assets/js/14.e733d709.js"><link rel="prefetch" href="/assets/js/16.f9c32fd4.js"><link rel="prefetch" href="/assets/js/17.10dcaa4f.js"><link rel="prefetch" href="/assets/js/18.1f5073bd.js"><link rel="prefetch" href="/assets/js/19.7aec6b89.js"><link rel="prefetch" href="/assets/js/20.d60a7af1.js"><link rel="prefetch" href="/assets/js/21.f8175986.js"><link rel="prefetch" href="/assets/js/22.5e02e305.js"><link rel="prefetch" href="/assets/js/23.215178c2.js"><link rel="prefetch" href="/assets/js/24.3de23924.js"><link rel="prefetch" href="/assets/js/25.1d9b7859.js"><link rel="prefetch" href="/assets/js/26.73a520a9.js"><link rel="prefetch" href="/assets/js/27.4be63923.js"><link rel="prefetch" href="/assets/js/28.573df509.js"><link rel="prefetch" href="/assets/js/29.d941dceb.js"><link rel="prefetch" href="/assets/js/30.3a0c371a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fae609a6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="router-link-active"><!----><span class="site-name">
      NoManReady
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><div class="dropdown-title"><span class="title">文章</span><span class="arrow"></span></div><ul class="nav-dropdown"><li class="dropdown-item"><!----><a href="/ow/" class="nav-link">Ow</a></li><li class="dropdown-item"><!----><a href="/javascript/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----><a href="/mockjs/" class="nav-link">Mockjs</a></li><li class="dropdown-item"><!----><a href="/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/gist/" class="nav-link">开源库</a></div><a href="https://github.com/NoManReady/NoManReady.github.io" target="_blank" rel="noopener" class="github-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><div class="dropdown-title"><span class="title">文章</span><span class="arrow"></span></div><ul class="nav-dropdown"><li class="dropdown-item"><!----><a href="/ow/" class="nav-link">Ow</a></li><li class="dropdown-item"><!----><a href="/javascript/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----><a href="/mockjs/" class="nav-link">Mockjs</a></li><li class="dropdown-item"><!----><a href="/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/gist/" class="nav-link">开源库</a></div><a href="https://github.com/NoManReady/NoManReady.github.io" target="_blank" rel="noopener" class="github-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><!----></div><div class="page"><div class="content"><h1 id="图片上传"><a href="#图片上传" aria-hidden="true" class="header-anchor">#</a> 图片上传</h1><h2 id="根据-input-获取用户选取的图片文件"><a href="#根据-input-获取用户选取的图片文件" aria-hidden="true" class="header-anchor">#</a> 根据 input 获取用户选取的图片文件</h2><p><code>let _file = this.$refs.input.files[0]</code></p><h2 id="将file-文件流通过-filereader-转化成-base64"><a href="#将file-文件流通过-filereader-转化成-base64" aria-hidden="true" class="header-anchor">#</a> 将file 文件流通过 FileReader 转化成 base64</h2><pre class="language-text"><code>/**
 * 文件流转base64
 * @param {file} source 图片对象
 * @param {number} quality 图片质量
 * @return {promise} promise 图片处理promise
 */
export const fileToBase64ByQuality = (file, quality) =&gt; {
  let fileReader = new FileReader()
  let type = file.type
  return new Promise((resolve, reject) =&gt; {
    if (window.URL || window.webkitURL) {
      resolve(compress(URL.createObjectURL(file), quality, type))
    } else {
      fileReader.onload = () =&gt; {
        resolve(compress(fileReader.result, quality, type))
      }
      fileReader.onerror = (e) =&gt; {
        reject(e)
      }
      fileReader.readAsDataURL(file)
    }
  })
}
</code></pre><h2 id="处理-base64-数据通过-canvas（todataurl）进行压缩绘制，然后输出压缩后的-base64-图片数据"><a href="#处理-base64-数据通过-canvas（todataurl）进行压缩绘制，然后输出压缩后的-base64-图片数据" aria-hidden="true" class="header-anchor">#</a> 处理 base64 数据通过 canvas（toDataURL）进行压缩绘制，然后输出压缩后的 base64 图片数据</h2><pre class="language-text"><code>//  图片最大宽度
const MAX_WIDTH = 800

/**
 * base64压缩（图片-canvas互转）
 * @param {file} base64 base64图片数据
 * @param {number} quality 图片质量
 * @param {string} format 输出图片格式
 * @return {base64} data 图片处理完成后的base64
 */
export const compress = (base64, quality, mimeType) =&gt; {
  let cvs = document.createElement('canvas')
  let img = document.createElement('img')
  img.crossOrigin = 'anonymous'
  return new Promise((resolve, reject) =&gt; {
    img.src = base64
    // 图片偏移值
    let offetX = 0
    img.onload = () =&gt; {
      if (img.width &gt; MAX_WIDTH) {
        cvs.width = MAX_WIDTH
        cvs.height = img.height * MAX_WIDTH / img.width
        offetX = (img.width - MAX_WIDTH) / 2
      } else {
        cvs.width = img.width
        cvs.height = img.height
      }
      let ctx = cvs.getContext(&quot;2d&quot;).drawImage(img, 0, 0, cvs.width, cvs.height)
      let imageData = cvs.toDataURL(mimeType, quality / 100)
      resolve(imageData)
    }
  })
}
</code></pre><h2 id="base64-数据转成-blob-文件流"><a href="#base64-数据转成-blob-文件流" aria-hidden="true" class="header-anchor">#</a> base64 数据转成 blob 文件流</h2><pre class="language-text"><code>/**
 * base64转文件流
 * @param {base64} base64数据
 * @param {string} format格式
 * @return {file}  文件blob
 */
export const convertBase64UrlToBlob = (base64, mimeType) =&gt; {
  let bytes = window.atob(base64.split(',')[1])
  let ab = new ArrayBuffer(bytes.length)
  let ia = new Uint8Array(ab)
  for (let i = 0; i &lt; bytes.length; i++) {
    ia[i] = bytes.charCodeAt(i)
  }
  let _blob = new Blob([ab], { type: mimeType })
  return _blob
}
</code></pre><h2 id="构造-formdata-数据进行文件的上传"><a href="#构造-formdata-数据进行文件的上传" aria-hidden="true" class="header-anchor">#</a> 构造 FormData 数据进行文件的上传</h2><pre class="language-text"><code>let formData = new window.FormData()
formData.append('file', _blob)
</code></pre></div><div class="vuepress" style="bottom:1.5em;right:1em;" data-v-7a80b806><span data-v-7a80b806>Top</span></div><div class="content edit-link"><a href="https://github.com/NoManReady/NoManReady.github.io/edit/dev/docs/vue/image.md" target="_blank">Edit this page</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div></div></div>
    <script src="/assets/js/3.e6e231a2.js" defer></script><script src="/assets/js/app.9b3061e8.js" defer></script>
  </body>
</html>
