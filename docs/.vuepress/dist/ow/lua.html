<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>NoManReady | 高性能 lua</title>
    <meta name="description" content="Enjoy Vue">
  <link rel="icon" href="/favicon.ico">
  <script src="/plugin.js" defer="defer"></script>
    
    <link rel="preload" href="/assets/css/0.styles.be8a8704.css" as="style"><link rel="preload" href="/assets/js/app.8dcc602c.js" as="script"><link rel="preload" href="/assets/js/1.8b51ff8c.js" as="script"><link rel="prefetch" href="/assets/js/12.c698d91f.js"><link rel="prefetch" href="/assets/js/2.a6c7bd87.js"><link rel="prefetch" href="/assets/js/3.a7cfa910.js"><link rel="prefetch" href="/assets/js/4.68f8fa61.js"><link rel="prefetch" href="/assets/js/5.fcc96d8e.js"><link rel="prefetch" href="/assets/js/6.93c86de0.js"><link rel="prefetch" href="/assets/js/7.5efbda3a.js"><link rel="prefetch" href="/assets/js/8.ff5fa809.js"><link rel="prefetch" href="/assets/js/9.d44f0197.js"><link rel="prefetch" href="/assets/js/10.8c5b6602.js"><link rel="prefetch" href="/assets/js/11.1ecc205e.js"><link rel="prefetch" href="/assets/js/13.66b9173d.js"><link rel="prefetch" href="/assets/js/14.a64934b0.js"><link rel="prefetch" href="/assets/js/15.0fd28328.js"><link rel="prefetch" href="/assets/js/16.f590ed14.js"><link rel="prefetch" href="/assets/js/17.9361e942.js"><link rel="prefetch" href="/assets/js/18.a17b3fb1.js"><link rel="prefetch" href="/assets/js/19.bd5f71ae.js"><link rel="prefetch" href="/assets/js/20.1f92b349.js"><link rel="prefetch" href="/assets/js/21.78748d78.js"><link rel="prefetch" href="/assets/js/22.3675192b.js"><link rel="prefetch" href="/assets/js/23.d1a716ff.js"><link rel="prefetch" href="/assets/js/24.a6f86fe8.js"><link rel="prefetch" href="/assets/js/25.9edc934b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.be8a8704.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="router-link-active"><!----><span class="site-name">
      NoManReady
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><div class="dropdown-title"><span class="title">文章</span><span class="arrow"></span></div><ul class="nav-dropdown"><li class="dropdown-item"><!----><a href="/ow/" class="nav-link router-link-active">Ow</a></li><li class="dropdown-item"><!----><a href="/javascript/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----><a href="/mockjs/" class="nav-link">Mockjs</a></li><li class="dropdown-item"><!----><a href="/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/gist/" class="nav-link">开源库</a></div><a href="https://github.com/NoManReady/NoManReady.github.io" target="_blank" rel="noopener" class="github-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><div class="dropdown-title"><span class="title">文章</span><span class="arrow"></span></div><ul class="nav-dropdown"><li class="dropdown-item"><!----><a href="/ow/" class="nav-link router-link-active">Ow</a></li><li class="dropdown-item"><!----><a href="/javascript/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----><a href="/mockjs/" class="nav-link">Mockjs</a></li><li class="dropdown-item"><!----><a href="/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/gist/" class="nav-link">开源库</a></div><a href="https://github.com/NoManReady/NoManReady.github.io" target="_blank" rel="noopener" class="github-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/ow/eweb.html" class="sidebar-link">Eweb项目结构</a></li><li><a href="/ow/lua.html" class="active sidebar-link">高性能 lua</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ow/lua.html#用-local-声明变量" class="sidebar-link">用 local 声明变量</a></li><li class="sidebar-sub-header"><a href="/ow/lua.html#预填充-table" class="sidebar-link">预填充 table</a></li><li class="sidebar-sub-header"><a href="/ow/lua.html#lua-字符串" class="sidebar-link">lua 字符串</a></li></ul></li></ul></div><div class="page"><div class="content"><h1 id="高性能-lua"><a href="#高性能-lua" aria-hidden="true" class="header-anchor">#</a> 高性能 lua</h1><h2 id="用-local-声明变量"><a href="#用-local-声明变量" aria-hidden="true" class="header-anchor">#</a> 用 local 声明变量</h2><blockquote><p>lua5.0 后 lua 采用寄存器式的模式，声明的 locla 变量都会存储在寄存器中</p></blockquote><pre class="language-text"><code>//声明local时产生的伪指令（a=a+b）：
//a是寄存器0 b是寄存器1
ADD 0 1
//若没有声明local即默认global变量产生的伪指令：
GETGLOBAL    0 0    ;get a
GETGLOBAL    1 1    ;get b
ADD          0 1    ;do add
SETGLOBAL    0 1    ;set a
</code></pre><p>所以声明 lua 变量时尽量用 local 声明变量的作用域，下面为测试结果：</p><pre class="language-text"><code>//每次调用全局的math.sin
a = os.clock()
for i = 1,10000000 do
  local x = math.sin(i)
end
b = os.clock()
print(b-a)

//每次调用局部的math.sin
a = os.clock()
local sin=math.sin
for i = 1,10000000 do
  local x = sin(i)
end
b = os.clock()
print(b-a)
</code></pre><h3 id="global"><a href="#global" aria-hidden="true" class="header-anchor">#</a> global</h3><p><img src="/img/global.png" alt="global"></p><h3 id="local"><a href="#local" aria-hidden="true" class="header-anchor">#</a> local</h3><p><img src="/img/local.png" alt="local"></p><h2 id="预填充-table"><a href="#预填充-table" aria-hidden="true" class="header-anchor">#</a> 预填充 table</h2><p>表在 Lua 中使用十分频繁，因为表几乎代替了 Lua 的所有容器。所以快速了解一下 Lua 底层是如何实现表，对我们编写 Lua 代码是有好处的。</p><p>Lua 的表分为两个部分：数组(array)部分和哈希(hash)部分。数组部分包含所有从 1 到 n 的整数键，其他的所有键都储存在哈希部分中。</p><p>哈希部分其实就是一个哈希表，哈希表本质是一个数组，它利用哈希算法将键转化为数组下标，若下标有冲突(即同一个下标对应了两个不同的键)，则它会将冲突的下标上创建一个链表，将不同的键串在这个链表上，这种解决冲突的方法叫做：链地址法。</p><p>当我们把一个新键值赋给表时，若数组和哈希表已经满了，则会触发一个再哈希(rehash)。再哈希的代价是高昂的。首先会在内存中分配一个新的长度的数组，然后将所有记录再全部哈希一遍，将原来的记录转移到新数组中。新哈希表的长度是最接近于所有元素数目的 2 的乘方。</p><pre class="language-text"><code>//以下代码执行时间为1.53秒：
a = os.clock()
for i = 1,2000000 do
    local a = {}
    a[1] = 1; a[2] = 2; a[3] = 3
end
b = os.clock()
print(b-a)  --1.528293

//如果我们在创建表的时候就填充好它的大小，则只需要0.75秒，一倍的效率提升！
a = os.clock()
for i = 1,2000000 do
    local a = {1,1,1}
    a[1] = 1; a[2] = 2; a[3] = 3
end
b = os.clock()
print(b-a)  --0.746453
</code></pre><ul><li>所以，当需要创建非常多的小 size 的表时，应预先填充好表的大小。</li></ul><h2 id="lua-字符串"><a href="#lua-字符串" aria-hidden="true" class="header-anchor">#</a> lua 字符串</h2><p>第一，所有的字符串在 Lua 中都只储存一份拷贝。当新字符串出现时，Lua 检查是否有其相同的拷贝，若没有则创建它，否则，指向这个拷贝。这可以使得字符串比较和表索引变得相当的快，因为比较字符串只需要检查引用是否一致即可；但是这也降低了创建字符串时的效率，因为 Lua 需要去查找比较一遍。</p><p>第二，所有的字符串变量，只保存字符串引用，而不保存它的 buffer。这使得字符串的赋值变得十分高效。例如在 Perl 中，$x = $y，会将$y 的 buffer 整个的复制到$x 的 buffer 中，当字符串很长时，这个操作的代价将十分昂贵。而在 Lua，同样的赋值，只复制引用，十分的高效。</p><pre class="language-text"><code>//在Lua中，以下代码将花费6.65秒：

a = os.clock()
local s = ''
for i = 1,300000 do
    s = s .. 'a'
end
b = os.clock()
print(b-a)  --6.649481
//我们可以用table来模拟buffer，下面的代码只需花费0.72秒，9倍多的效率提升：

a = os.clock()
local s = ''
local t = {}
for i = 1,300000 do
    t[#t + 1] = 'a'
end
s = table.concat( t, '')
b = os.clock()
print(b-a)  --0.07178
</code></pre><ul><li>所以：在大字符串连接中，我们应避免…。应用 table 来模拟 buffer，然后 concat 得到最终字符串。</li></ul><p><a href="http://wuzhiwei.net/lua_performance/" target="_blank" rel="noopener noreferrer">文章地址</a></p></div><div class="vuepress" style="bottom:1.5em;right:1em;" data-v-7a80b806><span data-v-7a80b806>Top</span></div><div class="content edit-link"><a href="https://github.com/NoManReady/NoManReady.github.io/edit/dev/docs/ow/lua.md" target="_blank">Edit this page</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/ow/eweb.html" class="prev">
          Eweb项目结构
        </a></span><!----></p></div></div></div></div>
    <script src="/assets/js/1.8b51ff8c.js" defer></script><script src="/assets/js/app.8dcc602c.js" defer></script>
  </body>
</html>
